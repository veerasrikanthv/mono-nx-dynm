"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const devkit_1 = require("@nx/devkit");
const executor_options_utils_1 = require("@nx/devkit/src/generators/executor-options-utils");
const path_1 = require("path");
const update_config_1 = require("../../utils/config/update-config");
function updateJestConfig(tree) {
    (0, executor_options_utils_1.forEachExecutorOptions)(tree, '@nrwl/jest:jest', (options, projectName) => {
        const config = require((0, path_1.join)(tree.root, options.jestConfig));
        // migrate serializers
        if (config.snapshotSerializers &&
            Array.isArray(config.snapshotSerializers)) {
            const snapshotSerializers = config.snapshotSerializers.map((snapshotSerializer) => {
                switch (snapshotSerializer) {
                    case 'jest-preset-angular/build/AngularNoNgAttributesSnapshotSerializer.js':
                        return 'jest-preset-angular/build/serializers/no-ng-attributes';
                    case 'jest-preset-angular/build/AngularSnapshotSerializer.js':
                        return 'jest-preset-angular/build/serializers/ng-snapshot';
                    case 'jest-preset-angular/build/HTMLCommentSerializer.js':
                        return 'jest-preset-angular/build/serializers/html-comment';
                    default:
                        return snapshotSerializer;
                }
            });
            try {
                (0, update_config_1.removePropertyFromJestConfig)(tree, options.jestConfig, 'snapshotSerializers');
                (0, update_config_1.addPropertyToJestConfig)(tree, options.jestConfig, 'snapshotSerializers', snapshotSerializers);
            }
            catch {
                devkit_1.logger.error((0, devkit_1.stripIndents) `Unable to update snapshotSerializers for project ${projectName}.
            More information you can check online documentation https://github.com/thymikee/jest-preset-angular/blob/master/CHANGELOG.md#840-2021-03-04`);
            }
        }
        try {
            const { sourceRoot } = (0, devkit_1.readProjectConfiguration)(tree, projectName);
            const setupTestPath = (0, path_1.join)(sourceRoot, 'test-setup.ts');
            if (tree.exists(setupTestPath)) {
                const contents = tree.read(setupTestPath, 'utf-8');
                tree.write(setupTestPath, contents.replace(`import 'jest-preset-angular';`, `import 'jest-preset-angular/setup-jest';`));
            }
        }
        catch {
            devkit_1.logger.error((0, devkit_1.stripIndents) `Unable to update test-setup.ts for project ${projectName}.`);
        }
    });
}
async function update(tree) {
    updateJestConfig(tree);
    await (0, devkit_1.formatFiles)(tree);
}
exports.default = update;
