"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const devkit_1 = require("@nx/devkit");
const path_1 = require("path");
const add_swc_config_1 = require("../../utils/swc/add-swc-config");
async function update(host) {
    const projects = (0, devkit_1.getProjects)(host);
    for (const config of projects.values()) {
        if (config?.targets?.build?.executor !== '@nrwl/js:swc')
            continue;
        const swcrcPath = (0, path_1.join)(config.root, '.swcrc');
        if (!host.exists(swcrcPath))
            continue;
        // rename
        const libSwcrcPath = (0, path_1.join)(config.root, '.lib.swcrc');
        host.rename(swcrcPath, libSwcrcPath);
        const swcrcContent = (0, devkit_1.readJson)(host, libSwcrcPath);
        // skip if swcrc already has "exclude" field
        if (swcrcContent['exclude'])
            continue;
        // check swcExclude build options
        const exclude = config?.targets?.build?.options?.['swcExclude'] || add_swc_config_1.defaultExclude;
        (0, devkit_1.updateJson)(host, libSwcrcPath, (swcrc) => {
            swcrc['exclude'] = exclude;
            return swcrc;
        });
    }
    await (0, devkit_1.formatFiles)(host);
}
exports.default = update;
