const a6_0x49f7=['options','note','NX_AGENT_NAME','../../../utilities/metric-logger','ENCRYPTION_KEY','length','getBranch','default','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','map','Distributed\x20Task\x20Execution\x20is\x20disabled\x20when\x20your\x20workspace\x20is\x20disabled','floor','unlinkSync','../../../utilities/nx-imports','CIRCLECI','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','submitRunMetrics','argv','Organization\x20administrators\x20can\x20find\x20more\x20information\x20on\x20the\x20\x27Billing\x20and\x20Plans\x27\x20page\x20in\x20the\x20Nx\x20Cloud\x20Webapp','printCacheableTargetsError','printInvalidRunnerError','cacheableOperations','filter','random','executeTasks','exit','Agent\x20was\x20terminated\x20via\x20SIGTERM','DistributedAgentApi','next','printRunGroupError','warn','CIRCLE_STAGE','targets','trim','parse','catch','invokeTasksUsingNxImperativeApi','/nx.json','Agent\x20was\x20terminated\x20via\x20SIGINT','DteArtifactStorage','isWorkspaceEnabled','getCIExecutionEnv','error','then','throw','runner','./execute-tasks','../../../utilities/is-workspace-enabled','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','../../../utilities/dte-artifact-storage','SIGTERM','/lockfiles','mkdirSync','dte-agent','__esModule','canDetectRunGroup','../../error/print-run-group-error','FileStorage','readFileSync','apply','Agent\x20','getRunGroup','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','startAgent','readdirSync','nx-cloud','getCIExecutionId','existsSync','value','__awaiter','split','completeRunGroupWithError','./distributed-agent.api','done','yargs-parser','../../error/print-cacheable-targets-error','toString','env','strip-json-comments','invokeTasksUsingRunMany','../../../utilities/environment','includes'];(function(_0x279bf8,_0x49f746){const _0x4d9df2=function(_0x14eda6){while(--_0x14eda6){_0x279bf8['push'](_0x279bf8['shift']());}};_0x4d9df2(++_0x49f746);}(a6_0x49f7,0x10a));const a6_0x4d9d=function(_0x279bf8,_0x49f746){_0x279bf8=_0x279bf8-0x0;let _0x4d9df2=a6_0x49f7[_0x279bf8];return _0x4d9df2;};'use strict';var __awaiter=this&&this[a6_0x4d9d('0x35')]||function(_0x31f839,_0x50fb9e,_0x541c84,_0x4dde73){function _0x273d00(_0x3ed00f){return _0x3ed00f instanceof _0x541c84?_0x3ed00f:new _0x541c84(function(_0x428a10){_0x428a10(_0x3ed00f);});}return new(_0x541c84||(_0x541c84=Promise))(function(_0x2f7727,_0x4cc94e){function _0x515aac(_0x49a40b){try{_0x3e4fdd(_0x4dde73[a6_0x4d9d('0xc')](_0x49a40b));}catch(_0x3f47d4){_0x4cc94e(_0x3f47d4);}}function _0x21006b(_0x125958){try{_0x3e4fdd(_0x4dde73[a6_0x4d9d('0x1c')](_0x125958));}catch(_0x83db25){_0x4cc94e(_0x83db25);}}function _0x3e4fdd(_0x209731){_0x209731[a6_0x4d9d('0x39')]?_0x2f7727(_0x209731[a6_0x4d9d('0x34')]):_0x273d00(_0x209731['value'])['then'](_0x515aac,_0x21006b);}_0x3e4fdd((_0x4dde73=_0x4dde73[a6_0x4d9d('0x2b')](_0x31f839,_0x50fb9e||[]))['next']());});};Object['defineProperty'](exports,a6_0x4d9d('0x26'),{'value':!![]});exports[a6_0x4d9d('0x2f')]=void 0x0;const fs_1=require('fs');const stripJsonComments=require(a6_0x4d9d('0x3e'));const yargsParser=require(a6_0x4d9d('0x3a'));const dte_artifact_storage_1=require(a6_0x4d9d('0x21'));const environment_1=require(a6_0x4d9d('0x40'));const is_workspace_enabled_1=require(a6_0x4d9d('0x1f'));const metric_logger_1=require(a6_0x4d9d('0x45'));const error_reporter_api_1=require('../../api/error-reporter.api');const print_cacheable_targets_error_1=require(a6_0x4d9d('0x3b'));const print_invalid_runner_error_1=require('../../error/print-invalid-runner-error');const print_run_group_error_1=require(a6_0x4d9d('0x28'));const e2e_encryption_1=require('../../file-storage/e2e-encryption');const file_storage_1=require('../../file-storage/file-storage');const distributed_agent_api_1=require(a6_0x4d9d('0x38'));const execute_tasks_1=require(a6_0x4d9d('0x1e'));const invoke_tasks_using_nx_imperative_api_1=require('./invoke-tasks-using-nx-imperative-api');const invoke_tasks_using_run_many_1=require('./invoke-tasks-using-run-many');const {output,workspaceRoot}=require('../../../utilities/nx-imports-light');const {initTasksRunner,cacheDirectory}=require(a6_0x4d9d('0x50'));const args=yargsParser(process[a6_0x4d9d('0x1')],{'array':[a6_0x4d9d('0x10')],'default':{}});if(args[a6_0x4d9d('0x10')]&&args[a6_0x4d9d('0x10')][a6_0x4d9d('0x47')]===0x1){args['targets']=args['targets'][0x0][a6_0x4d9d('0x36')](',')[a6_0x4d9d('0x4c')](_0x454492=>_0x454492[a6_0x4d9d('0x11')]());}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x1d19bf=(0x0,environment_1[a6_0x4d9d('0x48')])();const _0x23d502=(0x0,environment_1[a6_0x4d9d('0x2d')])();const _0x459436=(0x0,environment_1[a6_0x4d9d('0x32')])();const _0x14811c=(0x0,environment_1[a6_0x4d9d('0x19')])();if(!(0x0,print_run_group_error_1[a6_0x4d9d('0x27')])(_0x23d502,_0x459436)){(0x0,print_run_group_error_1[a6_0x4d9d('0xd')])();process[a6_0x4d9d('0x9')](0x1);}if(args[a6_0x4d9d('0x10')]&&args[a6_0x4d9d('0x10')][a6_0x4d9d('0x47')]){output['note']({'title':'Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20['+args[a6_0x4d9d('0x10')]['join'](',\x20')+']'});}else{output[a6_0x4d9d('0x43')]({'title':a6_0x4d9d('0x4b')});}const _0x4a9a9e=JSON[a6_0x4d9d('0x12')](stripJsonComments((0x0,fs_1[a6_0x4d9d('0x2a')])(workspaceRoot+a6_0x4d9d('0x15'))[a6_0x4d9d('0x3c')]()))['tasksRunnerOptions'][a6_0x4d9d('0x49')];if(_0x4a9a9e['runner']!==a6_0x4d9d('0x31')&&_0x4a9a9e[a6_0x4d9d('0x1d')]!=='@nrwl/nx-cloud'){(0x0,print_invalid_runner_error_1[a6_0x4d9d('0x4')])();return process[a6_0x4d9d('0x9')](0x1);}const _0x133c33=_0x4a9a9e[a6_0x4d9d('0x42')];if(args[a6_0x4d9d('0x10')]&&args['targets']['some'](_0x326c76=>{var _0x426042;return!((_0x426042=_0x133c33[a6_0x4d9d('0x5')])===null||_0x426042===void 0x0?void 0x0:_0x426042[a6_0x4d9d('0x41')](_0x326c76));})){const _0x26bb9f=args[a6_0x4d9d('0x10')][a6_0x4d9d('0x6')](_0xc298f7=>{var _0x5b4cff;return!((_0x5b4cff=_0x133c33['cacheableOperations'])===null||_0x5b4cff===void 0x0?void 0x0:_0x5b4cff[a6_0x4d9d('0x41')](_0xc298f7));});(0x0,print_cacheable_targets_error_1[a6_0x4d9d('0x3')])(_0x26bb9f);return process['exit'](0x1);}const _0x2f33b6=yield(0x0,is_workspace_enabled_1[a6_0x4d9d('0x18')])(_0x133c33);if(!_0x2f33b6){output[a6_0x4d9d('0x1a')]({'title':'Nx\x20Cloud:\x20Workspace\x20is\x20disabled','bodyLines':[a6_0x4d9d('0x4d'),'',a6_0x4d9d('0x2')]});process[a6_0x4d9d('0x9')](0x1);}const _0x2a43c5=getAgentName();const _0x3621cf=new distributed_agent_api_1[(a6_0x4d9d('0xb'))](_0x133c33,_0x1d19bf,_0x23d502,_0x459436,_0x14811c,_0x2a43c5);createAgentLockfileAndSetUpListeners(_0x3621cf,_0x133c33,_0x2a43c5);const _0x54a2ea=new e2e_encryption_1['E2EEncryption'](environment_1[a6_0x4d9d('0x46')]||_0x133c33['encryptionKey']);const _0x3192c1=new error_reporter_api_1['ErrorReporterApi'](_0x133c33);const _0x334fd4=new dte_artifact_storage_1[(a6_0x4d9d('0x17'))](new file_storage_1[(a6_0x4d9d('0x29'))](_0x54a2ea,_0x3192c1,_0x133c33,a6_0x4d9d('0x25')),cacheDirectory);const _0x1fe8d9=initTasksRunner?yield(0x0,invoke_tasks_using_nx_imperative_api_1[a6_0x4d9d('0x14')])(_0x133c33):yield(0x0,invoke_tasks_using_run_many_1[a6_0x4d9d('0x3f')])();return(0x0,execute_tasks_1[a6_0x4d9d('0x8')])(_0x2a43c5,_0x3621cf,_0x334fd4,_0x1fe8d9,args[a6_0x4d9d('0x10')])[a6_0x4d9d('0x1b')](_0x2f9f49=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x4d9d('0x0')])(_0x133c33);return _0x2f9f49;}))[a6_0x4d9d('0x13')](_0x12646d=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x3621cf[a6_0x4d9d('0x37')]('Critical\x20Error\x20in\x20Agent:\x20\x22'+_0x12646d['message']+'\x22');throw _0x12646d;}));});}exports['startAgent']=startAgent;function getAgentName(){if(process[a6_0x4d9d('0x3d')][a6_0x4d9d('0x44')]!==undefined){return process[a6_0x4d9d('0x3d')][a6_0x4d9d('0x44')];}else if(process[a6_0x4d9d('0x3d')][a6_0x4d9d('0x51')]!==undefined&&process['env'][a6_0x4d9d('0xf')]){return process[a6_0x4d9d('0x3d')]['CIRCLE_STAGE'];}else if(process[a6_0x4d9d('0x3d')]['CIRCLECI']!==undefined&&process[a6_0x4d9d('0x3d')]['CIRCLE_JOB']){return process[a6_0x4d9d('0x3d')]['CIRCLE_JOB'];}else{return a6_0x4d9d('0x2c')+Math[a6_0x4d9d('0x4e')](Math[a6_0x4d9d('0x7')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x307532,_0x8e9ad9,_0x53e32d){const _0x35f1e6=cacheDirectory+a6_0x4d9d('0x23');const _0x313ef7=_0x35f1e6+'/'+_0x53e32d+'.lock';if(!(0x0,fs_1['existsSync'])(_0x35f1e6)){(0x0,fs_1[a6_0x4d9d('0x24')])(_0x35f1e6,{'recursive':!![]});}const _0x52bc10=(0x0,fs_1[a6_0x4d9d('0x30')])(_0x35f1e6);if(_0x52bc10[a6_0x4d9d('0x47')]){if(_0x52bc10[a6_0x4d9d('0x41')](_0x53e32d+'.lock')){output[a6_0x4d9d('0x1a')]({'title':'Duplicate\x20Agent\x20ID\x20Detected','bodyLines':[a6_0x4d9d('0x52'),'',a6_0x4d9d('0x4a')]});process[a6_0x4d9d('0x9')](0x1);}output[a6_0x4d9d('0xe')]({'title':'Other\x20Nx\x20Cloud\x20Agents\x20Detected','bodyLines':['We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','',a6_0x4d9d('0x20'),a6_0x4d9d('0x2e')]});}(0x0,fs_1['writeFileSync'])(_0x313ef7,'');process['on']('exit',_0xec9f1d=>{cleanupAgentLockfile(_0x313ef7,_0xec9f1d);});process['on'](a6_0x4d9d('0x22'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x307532[a6_0x4d9d('0x37')](a6_0x4d9d('0xa'));cleanupAgentLockfile(_0x313ef7,0x1);}));process['on']('SIGINT',()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x307532[a6_0x4d9d('0x37')](a6_0x4d9d('0x16'));cleanupAgentLockfile(_0x313ef7,0x1);}));}function cleanupAgentLockfile(_0x31f867,_0x1f214c){if((0x0,fs_1[a6_0x4d9d('0x33')])(_0x31f867)){(0x0,fs_1[a6_0x4d9d('0x4f')])(_0x31f867);process[a6_0x4d9d('0x9')](_0x1f214c);}}