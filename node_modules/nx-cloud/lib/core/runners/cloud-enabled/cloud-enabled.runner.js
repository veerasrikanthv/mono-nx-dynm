const a1_0x4a45=['Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20store\x20artifacts.','./cloud-enabled-life-cycle','NX_CLOUD_DISTRIBUTED_EXECUTION_ID','endRun','waitForStoreRequestsToComplete','push','done','startRun','then','uploadedToStorage','MessageReporter','../../terminal-output/output-obfuscator','toString','hash','getRunGroup','./cloud-remote-cache','extractGitSha','\x20isn\x27t\x20recorded','OutputObfuscator','subscribe','Nx\x20Cloud\x20wasn\x27t\x20able\x20to\x20record\x20its\x20run.','requests','assign','cacheStatus','cloud-enabled-runner','runUrl','apply','./cloud-run.api','error','join','delayedStoreRequests','throw','local-cache-hit','CloudRunApi','url','daemon','../../file-storage/e2e-encryption','accessToken','ErrorReporterApi','getMachineInfo','resolve','getCIExecutionId','cloudEnabledTasksRunner','../../../utilities/nx-imports','ACCESS_TOKEN','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','toISOString','Executed\x20tasks\x20with\x20hashes:\x20','all','rxjs/internal/Subject','Task\x20with\x20hash\x20','pathExists','env','/runs/','value','stringify','.commit','../../terminal-output/message-reporter','CloudRemoteCache','store','FileStorage','writeFileSync','catch','find','forEach','length','../../api/error-reporter.api','skipNxCache','defineProperty','path','taskId','nx-cloud/lib/daemon/process-run-end','anyErrors','removeTrailingSlash','CloudEnabledLifeCycle','agentRunningInDistributedExecution','__awaiter','filter','VERBOSE_LOGGING','obfuscate','E2EEncryption','../../file-storage/file-storage','printCacheHitsMessage','printMessages','../../../utilities/environment','fs-extra','../../../utilities/metric-logger','map','enabled','ENCRYPTION_KEY','next','complete','../../terminal-output/end-of-run-message','maskedProperties','encryptionKey','exit'];(function(_0x412771,_0x4a4566){const _0xd98153=function(_0x2518ab){while(--_0x2518ab){_0x412771['push'](_0x412771['shift']());}};_0xd98153(++_0x4a4566);}(a1_0x4a45,0x175));const a1_0xd981=function(_0x412771,_0x4a4566){_0x412771=_0x412771-0x0;let _0xd98153=a1_0x4a45[_0x412771];return _0xd98153;};'use strict';var __awaiter=this&&this[a1_0xd981('0x57')]||function(_0x54ca10,_0x483ccf,_0x495745,_0x4df57c){function _0x1ca3b2(_0x2f39c1){return _0x2f39c1 instanceof _0x495745?_0x2f39c1:new _0x495745(function(_0x185152){_0x185152(_0x2f39c1);});}return new(_0x495745||(_0x495745=Promise))(function(_0x45e89c,_0x29323a){function _0xf60f16(_0x4b4a8c){try{_0x5ac429(_0x4df57c[a1_0xd981('0x5')](_0x4b4a8c));}catch(_0x25193c){_0x29323a(_0x25193c);}}function _0x477cce(_0x5ecb1d){try{_0x5ac429(_0x4df57c[a1_0xd981('0x2a')](_0x5ecb1d));}catch(_0x2a3e33){_0x29323a(_0x2a3e33);}}function _0x5ac429(_0x387f96){_0x387f96[a1_0xd981('0x11')]?_0x45e89c(_0x387f96[a1_0xd981('0x41')]):_0x1ca3b2(_0x387f96[a1_0xd981('0x41')])[a1_0xd981('0x13')](_0xf60f16,_0x477cce);}_0x5ac429((_0x4df57c=_0x4df57c[a1_0xd981('0x25')](_0x54ca10,_0x483ccf||[]))[a1_0xd981('0x5')]());});};Object[a1_0xd981('0x4f')](exports,'__esModule',{'value':!![]});exports[a1_0xd981('0x35')]=void 0x0;const fs_1=require('fs');const fs_extra_1=require(a1_0xd981('0x0'));const path=require('path');const path_1=require(a1_0xd981('0x50'));const environment_1=require(a1_0xd981('0x5f'));const metric_logger_1=require(a1_0xd981('0x1'));const remove_trailing_slash_1=require('../../../utilities/remove-trailing-slash');const error_reporter_api_1=require(a1_0xd981('0x4d'));const e2e_encryption_1=require(a1_0xd981('0x2f'));const file_storage_1=require(a1_0xd981('0x5c'));const end_of_run_message_1=require(a1_0xd981('0x7'));const message_reporter_1=require(a1_0xd981('0x44'));const output_obfuscator_1=require(a1_0xd981('0x16'));const cloud_enabled_life_cycle_1=require(a1_0xd981('0xc'));const cloud_remote_cache_1=require(a1_0xd981('0x1a'));const cloud_run_api_1=require(a1_0xd981('0x26'));const id_generator_1=require('./id-generator');const {output}=require('../../../utilities/nx-imports-light');const {tasksRunner,cacheDirectory}=require(a1_0xd981('0x36'));function createApi(_0x308fb8,_0x1f2390,_0x1effa3){const _0x1d3920=(0x0,environment_1[a1_0xd981('0x32')])();return new cloud_run_api_1[(a1_0xd981('0x2c'))](_0x308fb8,_0x1effa3,_0x1f2390,_0x1d3920);}function storeTaskHashes(_0x7c54cc,_0x4aa9ab,_0x2d3dad){const _0x4642a7=JSON[a1_0xd981('0x42')](_0x7c54cc[a1_0xd981('0x2')](_0x4dbef3=>({'taskId':_0x4dbef3[a1_0xd981('0x51')],'hash':_0x4dbef3[a1_0xd981('0x18')]})));if(environment_1[a1_0xd981('0x59')]){output['note']({'title':a1_0xd981('0x3a')+_0x4642a7});}(0x0,fs_1[a1_0xd981('0x48')])(path['join'](_0x4aa9ab,'tasks-hashes-'+_0x2d3dad),_0x4642a7);}function storeLocalCacheHits(_0x2b7098,_0x1196ea,_0x2b30f0){const _0x41b0a1=_0x2b7098[a1_0xd981('0x58')](_0x4fbeb1=>_0x4fbeb1[a1_0xd981('0x22')]===a1_0xd981('0x2b'))['map'](_0x234de7=>_0x234de7[a1_0xd981('0x18')]);_0x41b0a1[a1_0xd981('0x4b')](_0x2a4e79=>_0x1196ea[a1_0xd981('0x46')](_0x2a4e79,_0x2b30f0));}function onComplete({daemon,options,fileStorage,remoteCache,api,outputObfuscator,runStartTime,messages,endOfRunMessage,taskExecutions,versionOfNxBefore133,inner,encryptionKey,storeInCurrentProcess,distributedExecutionId,runContext}){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x2aa1ad=new Date()[a1_0xd981('0x39')]();const _0xa4575b=(0x0,environment_1['getBranch'])();const _0x46b34f={'command':outputObfuscator[a1_0xd981('0x5a')]((0x0,environment_1['parseCommand'])()),'startTime':runStartTime,'endTime':_0x2aa1ad,'distributedExecutionId':distributedExecutionId,'branch':_0xa4575b,'runGroup':(0x0,environment_1[a1_0xd981('0x19')])(),'sha':_0xa4575b?(0x0,environment_1[a1_0xd981('0x1b')])():undefined,'inner':inner};const _0x4859fb={'branch':_0xa4575b,'runGroup':(0x0,environment_1['getRunGroup'])(),'ciExecutionId':(0x0,environment_1[a1_0xd981('0x34')])(),'ciExecutionEnv':(0x0,environment_1['getCIExecutionEnv'])()};if(storeInCurrentProcess){if((0x0,environment_1['agentRunningInDistributedExecution'])(distributedExecutionId)){storeTaskHashes(taskExecutions,cacheDirectory,distributedExecutionId);storeLocalCacheHits(taskExecutions,remoteCache,cacheDirectory);}try{yield remoteCache[a1_0xd981('0xf')]();}catch(_0x595714){output[a1_0xd981('0x27')]({'title':a1_0xd981('0xb')});messages['printMessages']();return![];}for(const _0x2bd2eb of fileStorage['storedHashes']){const _0x58bba8=taskExecutions[a1_0xd981('0x4a')](_0x483510=>_0x483510[a1_0xd981('0x18')]===_0x2bd2eb);if(!_0x58bba8){throw new Error(a1_0xd981('0x3d')+_0x2bd2eb+a1_0xd981('0x1c'));}_0x58bba8[a1_0xd981('0x14')]=!![];}try{yield api[a1_0xd981('0xe')](_0x46b34f,taskExecutions,_0x4859fb);}catch(_0x2fee71){output[a1_0xd981('0x27')]({'title':a1_0xd981('0x1f')});messages[a1_0xd981('0x5e')]();return![];}yield(0x0,metric_logger_1['submitRunMetrics'])(options);}else{try{const _0x8bab48=environment_1[a1_0xd981('0x37')]?environment_1[a1_0xd981('0x37')]:options[a1_0xd981('0x30')];const _0x387cd1=(0x0,id_generator_1['generateUniqueLinkId'])();const _0x388e86=require[a1_0xd981('0x33')](a1_0xd981('0x52'));yield daemon['processInBackground'](_0x388e86,{'encryptionKey':encryptionKey,'runnerOptions':Object[a1_0xd981('0x21')](Object[a1_0xd981('0x21')]({},options),{'accessToken':_0x8bab48}),'delayedStoreRequests':remoteCache[a1_0xd981('0x29')],'ciExecutionContext':_0x4859fb,'runEnd':{'runData':_0x46b34f,'taskExecutions':taskExecutions,'linkId':_0x387cd1}});runContext[a1_0xd981('0x24')]=(0x0,remove_trailing_slash_1[a1_0xd981('0x54')])(options[a1_0xd981('0x2d')]||'https://nx.app')+a1_0xd981('0x40')+_0x387cd1;}catch(_0x15013a){output['warn']({'title':'Nx\x20Cloud\x20Problems','bodyLines':[_0x15013a['message']||_0x15013a[a1_0xd981('0x17')]()]});return![];}}if(versionOfNxBefore133){setTimeout(()=>{messages[a1_0xd981('0x5e')]();if(!messages[a1_0xd981('0x53')]&&!inner){endOfRunMessage[a1_0xd981('0x5d')]();}},0x0);}else{messages['printMessages']();if(!messages[a1_0xd981('0x53')]&&!inner){endOfRunMessage[a1_0xd981('0x5d')]();}}return!![];});}function createLifeCycle(_0x55be89,_0x1a8ca0,_0x4c27c0,_0x1db794){const _0x40197f=new cloud_enabled_life_cycle_1[(a1_0xd981('0x55'))](_0x55be89,cacheDirectory,!![],_0x1a8ca0['cacheableOperations']||[],_0x4c27c0,_0x1db794);try{const {CompositeLifeCycle}=require(a1_0xd981('0x36'));if(!CompositeLifeCycle)return _0x40197f;return new CompositeLifeCycle([_0x1a8ca0['lifeCycle'],_0x40197f]);}catch(_0x4cdb3f){return _0x40197f;}}function fetchUrlsForKnownHashesUpfront(_0x44120f,_0x36ec94,_0x266aa3,_0xf4960d,_0x1fa473){return __awaiter(this,void 0x0,void 0x0,function*(){if(_0xf4960d[a1_0xd981('0x4e')])return;let _0x19cf6a=_0x266aa3[a1_0xd981('0x2')](_0x1c0ad1=>_0x1c0ad1[a1_0xd981('0x18')])[a1_0xd981('0x58')](_0x474315=>!!_0x474315);const _0x19f639=yield Promise[a1_0xd981('0x3b')](_0x19cf6a[a1_0xd981('0x2')](_0x147cdc=>{const _0x3e67bb=(0x0,path_1[a1_0xd981('0x28')])(cacheDirectory,_0x147cdc+a1_0xd981('0x43'));return(0x0,fs_extra_1[a1_0xd981('0x3e')])(_0x3e67bb);}));const _0x1fc22e=[];for(let _0x5417bb=0x0;_0x5417bb<_0x19f639['length'];++_0x5417bb){if(!_0x19f639[_0x5417bb]){_0x1fc22e[a1_0xd981('0x10')](_0x19cf6a[_0x5417bb]);}}if(_0x1fc22e[a1_0xd981('0x4c')]>0x0){const _0x1c696e=_0x44120f[a1_0xd981('0x12')](_0x1fa473,_0x1fc22e);for(const _0x32c133 of _0x1fc22e){_0x36ec94[a1_0xd981('0x20')][_0x32c133]=_0x1c696e;}}});}function cloudEnabledTasksRunner(_0x18272b,_0x4d6ba1,_0x993052,_0x258625=![]){var _0x332191;const _0x316655=process[a1_0xd981('0x3f')][a1_0xd981('0xd')];const _0x3d63db={'statuses':{},'scheduledTasks':[],'requests':{},'allTasks':_0x18272b};const _0x1a0caf=_0x4d6ba1['lifeCycle']===undefined;const _0x961e48=[];const _0x4d0086=new message_reporter_1[(a1_0xd981('0x15'))](_0x4d6ba1);const _0x3c6226=createApi(_0x4d0086,_0x4d6ba1,_0x3d63db);const _0x38dd25=new end_of_run_message_1['EndOfRunMessage'](_0x3d63db,_0x961e48,_0x316655);const _0x3d6d63=new output_obfuscator_1[(a1_0xd981('0x1d'))](_0x4d6ba1[a1_0xd981('0x8')]);const _0x382b04=new Date()[a1_0xd981('0x39')]();const _0x1e3fa6=createLifeCycle(_0x3d63db,_0x4d6ba1,_0x3d6d63,_0x961e48);const _0x147740=environment_1[a1_0xd981('0x4')]||_0x4d6ba1[a1_0xd981('0x9')];const _0x24911a=new e2e_encryption_1[(a1_0xd981('0x5b'))](_0x147740);const _0x15b290=new error_reporter_api_1[(a1_0xd981('0x31'))](_0x4d6ba1);const _0xe0918=(0x0,environment_1[a1_0xd981('0x56')])(_0x316655)||!((_0x332191=_0x993052['daemon'])===null||_0x332191===void 0x0?void 0x0:_0x332191[a1_0xd981('0x3')]());const _0x4fca5f=new file_storage_1[(a1_0xd981('0x47'))](_0x24911a,_0x15b290,_0x4d6ba1,a1_0xd981('0x23'));const _0x2febef=new cloud_remote_cache_1[(a1_0xd981('0x45'))](_0x4d0086,_0x3c6226,_0x3d63db,_0x4fca5f,_0x316655,_0xe0918);fetchUrlsForKnownHashesUpfront(_0x3c6226,_0x3d63db,_0x18272b,_0x4d6ba1,_0x316655);delete process[a1_0xd981('0x3f')][a1_0xd981('0xd')];const _0x567fcd=tasksRunner(_0x18272b,Object[a1_0xd981('0x21')](Object['assign']({},_0x4d6ba1),{'remoteCache':_0x2febef,'lifeCycle':_0x1e3fa6}),_0x993052);if(_0x567fcd[a1_0xd981('0x1e')]){const {Subject}=require(a1_0xd981('0x3c'));const _0x31c7d9=new Subject();_0x567fcd[a1_0xd981('0x1e')]({'next':_0x289f36=>_0x31c7d9[a1_0xd981('0x5')](_0x289f36),'error':_0x5aa28c=>_0x31c7d9[a1_0xd981('0x27')](_0x5aa28c),'complete':()=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x440a8e=yield onComplete({'daemon':_0x993052[a1_0xd981('0x2e')],'options':_0x4d6ba1,'fileStorage':_0x4fca5f,'remoteCache':_0x2febef,'api':_0x3c6226,'outputObfuscator':_0x3d6d63,'runStartTime':_0x382b04,'messages':_0x4d0086,'endOfRunMessage':_0x38dd25,'taskExecutions':_0x961e48,'versionOfNxBefore133':_0x1a0caf,'inner':_0x258625,'encryptionKey':_0x147740,'storeInCurrentProcess':_0xe0918,'runContext':_0x3d63db,'distributedExecutionId':_0x316655});if(!_0x440a8e&&(0x0,environment_1['agentRunningInDistributedExecution'])(_0x316655)){process[a1_0xd981('0xa')](environment_1[a1_0xd981('0x38')]);}_0x31c7d9[a1_0xd981('0x6')]();})});return _0x31c7d9;}else{return _0x567fcd[a1_0xd981('0x13')](_0x4cc0b1=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x341f7c=yield onComplete({'daemon':_0x993052[a1_0xd981('0x2e')],'options':_0x4d6ba1,'fileStorage':_0x4fca5f,'remoteCache':_0x2febef,'api':_0x3c6226,'outputObfuscator':_0x3d6d63,'runStartTime':_0x382b04,'messages':_0x4d0086,'endOfRunMessage':_0x38dd25,'taskExecutions':_0x961e48,'versionOfNxBefore133':_0x1a0caf,'inner':_0x258625,'encryptionKey':_0x147740,'storeInCurrentProcess':_0xe0918,'runContext':_0x3d63db,'distributedExecutionId':_0x316655});if(!_0x341f7c&&(0x0,environment_1[a1_0xd981('0x56')])(_0x316655)){process[a1_0xd981('0xa')](environment_1[a1_0xd981('0x38')]);}return _0x4cc0b1;}))[a1_0xd981('0x49')](_0x2542d0=>__awaiter(this,void 0x0,void 0x0,function*(){const _0x40adfd=yield onComplete({'daemon':_0x993052[a1_0xd981('0x2e')],'options':_0x4d6ba1,'fileStorage':_0x4fca5f,'remoteCache':_0x2febef,'api':_0x3c6226,'outputObfuscator':_0x3d6d63,'runStartTime':_0x382b04,'messages':_0x4d0086,'endOfRunMessage':_0x38dd25,'taskExecutions':_0x961e48,'versionOfNxBefore133':_0x1a0caf,'inner':_0x258625,'encryptionKey':_0x147740,'storeInCurrentProcess':_0xe0918,'runContext':_0x3d63db,'distributedExecutionId':_0x316655});if(!_0x40adfd&&(0x0,environment_1[a1_0xd981('0x56')])(_0x316655)){process[a1_0xd981('0xa')](environment_1[a1_0xd981('0x38')]);}throw _0x2542d0;}));}}exports[a1_0xd981('0x35')]=cloudEnabledTasksRunner;